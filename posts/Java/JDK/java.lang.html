<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://riicarus.github.io/posts/Java/JDK/java.lang.html"><meta property="og:site_name" content="Riicarus"><meta property="og:title" content="Java.lang åŒ…"><meta property="og:description" content="Java.lang åŒ… 1 Object public class Object { private static native void registerNatives(); static { registerNatives(); } // è¿”å› è°ƒç”¨ç±» çš„ è¢« static synchronized ä¿®é¥°çš„ ç±»å‹æ“¦é™¤å¯¹è±¡ public final native Class&lt;?&gt; getClass(); // è¿”å›å¯¹è±¡çš„å“ˆå¸Œå€¼, å¯¹ HashMap è¿›è¡Œæ”¯æŒ public native int hashCode(); // æ¯”è¾ƒå¯¹è±¡æ˜¯å¦ç›¸åŒ, å…·æœ‰ è‡ªåã€å¯¹ç§°ã€ä¼ é€’ã€ä¸€è‡´æ€§ // åªæœ‰å¼•ç”¨çš„å†…å­˜åœ°å€ç›¸åŒæ‰åˆ¤å®šç›¸åŒ // å¦‚æœè¦é‡å†™æ­¤æ–¹æ³•, éœ€è¦åŒæ—¶é‡å†™ hashCode æ–¹æ³•, ç›®çš„æ˜¯ç»´æŒ hashCode æ–¹æ³•çš„ä¸€èˆ¬çº¦å®š(ç›¸ç­‰çš„å¯¹è±¡å¿…é¡»æœ‰ç›¸åŒçš„å“ˆå¸Œç ) public boolean equals(Object obj) { return (this == obj); } // è¿”å›å½“å‰å¯¹è±¡çš„å¤åˆ¶å¯¹è±¡ // æ‹·è´è¦æ±‚ï¼šå®ç° Cloneable æ¥å£ // æ‹·è´æ–¹å¼ï¼šæµ…æ‹·è´ protected native Object clone() throws CloneNotSupportedException; // è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼, å»ºè®®æ‰€æœ‰ç±»éƒ½é‡å†™æ­¤æ–¹æ³• // è¿”å› ç±»å®ä¾‹åç§°@å¯¹è±¡å“ˆå¸Œç çš„æ— ç¬¦å·åå…­è¿›åˆ¶è¡¨ç¤º public String toString() { return getClass().getName() + "@" + Integer.toHexString(hashCode()); } // å”¤é†’åœ¨è¯¥å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„(æŸä¸€ä¸ª)çº¿ç¨‹, è¿›å…¥çº¿ç¨‹å°±ç»ªçŠ¶æ€ public final native void notify(); // å”¤é†’åœ¨è¯¥å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹, è¿›å…¥çº¿ç¨‹å°±ç»ªçŠ¶æ€ public final native void notifyAll(); // è®©çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€, ç›´åˆ°è¢« notify()/notifyAll() å”¤é†’, æˆ–è€…è¶…è¿‡æŒ‡å®šç­‰å¾…æ—¶é—´ public final native void wait(long timeout) throws InterruptedException; // åŒä¸Š public final void wait(long timeout, int nanos) throws InterruptedException { if (timeout &lt; 0) { throw new IllegalArgumentException("timeout value is negative"); } if (nanos &lt; 0 || nanos &gt; 999999) { throw new IllegalArgumentException( "nanosecond timeout value out of range"); } if (nanos &gt; 0) { timeout++; } wait(timeout); } // ä½¿çº¿ç¨‹è¿›å…¥é•¿æœŸç­‰å¾…çŠ¶æ€, ç›´åˆ°ä¸”åªèƒ½è¢« notify()/notifyAll() å”¤é†’ public final void wait() throws InterruptedException { wait(0); } // å½“ç¡®å®šæ²¡æœ‰å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨çš„æ—¶å€™, ç”±åƒåœ¾æ”¶é›†å™¨åœ¨å¯¹è±¡ä¸Šè¿›è¡Œè°ƒç”¨ protected void finalize() throws Throwable { } }"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-09-26T12:54:06.000Z"><meta property="article:tag" content="Java"><meta property="article:tag" content="JDK"><meta property="article:tag" content="java.lang"><meta property="article:published_time" content="2023-03-29T00:00:00.000Z"><meta property="article:modified_time" content="2023-09-26T12:54:06.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Java.lang åŒ…","image":[""],"datePublished":"2023-03-29T00:00:00.000Z","dateModified":"2023-09-26T12:54:06.000Z","author":[]}</script><link rel="icon" href="/logo.png"><title>Java.lang åŒ… | Riicarus</title><meta name="description" content="Java.lang åŒ… 1 Object public class Object { private static native void registerNatives(); static { registerNatives(); } // è¿”å› è°ƒç”¨ç±» çš„ è¢« static synchronized ä¿®é¥°çš„ ç±»å‹æ“¦é™¤å¯¹è±¡ public final native Class&lt;?&gt; getClass(); // è¿”å›å¯¹è±¡çš„å“ˆå¸Œå€¼, å¯¹ HashMap è¿›è¡Œæ”¯æŒ public native int hashCode(); // æ¯”è¾ƒå¯¹è±¡æ˜¯å¦ç›¸åŒ, å…·æœ‰ è‡ªåã€å¯¹ç§°ã€ä¼ é€’ã€ä¸€è‡´æ€§ // åªæœ‰å¼•ç”¨çš„å†…å­˜åœ°å€ç›¸åŒæ‰åˆ¤å®šç›¸åŒ // å¦‚æœè¦é‡å†™æ­¤æ–¹æ³•, éœ€è¦åŒæ—¶é‡å†™ hashCode æ–¹æ³•, ç›®çš„æ˜¯ç»´æŒ hashCode æ–¹æ³•çš„ä¸€èˆ¬çº¦å®š(ç›¸ç­‰çš„å¯¹è±¡å¿…é¡»æœ‰ç›¸åŒçš„å“ˆå¸Œç ) public boolean equals(Object obj) { return (this == obj); } // è¿”å›å½“å‰å¯¹è±¡çš„å¤åˆ¶å¯¹è±¡ // æ‹·è´è¦æ±‚ï¼šå®ç° Cloneable æ¥å£ // æ‹·è´æ–¹å¼ï¼šæµ…æ‹·è´ protected native Object clone() throws CloneNotSupportedException; // è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼, å»ºè®®æ‰€æœ‰ç±»éƒ½é‡å†™æ­¤æ–¹æ³• // è¿”å› ç±»å®ä¾‹åç§°@å¯¹è±¡å“ˆå¸Œç çš„æ— ç¬¦å·åå…­è¿›åˆ¶è¡¨ç¤º public String toString() { return getClass().getName() + "@" + Integer.toHexString(hashCode()); } // å”¤é†’åœ¨è¯¥å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„(æŸä¸€ä¸ª)çº¿ç¨‹, è¿›å…¥çº¿ç¨‹å°±ç»ªçŠ¶æ€ public final native void notify(); // å”¤é†’åœ¨è¯¥å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹, è¿›å…¥çº¿ç¨‹å°±ç»ªçŠ¶æ€ public final native void notifyAll(); // è®©çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€, ç›´åˆ°è¢« notify()/notifyAll() å”¤é†’, æˆ–è€…è¶…è¿‡æŒ‡å®šç­‰å¾…æ—¶é—´ public final native void wait(long timeout) throws InterruptedException; // åŒä¸Š public final void wait(long timeout, int nanos) throws InterruptedException { if (timeout &lt; 0) { throw new IllegalArgumentException("timeout value is negative"); } if (nanos &lt; 0 || nanos &gt; 999999) { throw new IllegalArgumentException( "nanosecond timeout value out of range"); } if (nanos &gt; 0) { timeout++; } wait(timeout); } // ä½¿çº¿ç¨‹è¿›å…¥é•¿æœŸç­‰å¾…çŠ¶æ€, ç›´åˆ°ä¸”åªèƒ½è¢« notify()/notifyAll() å”¤é†’ public final void wait() throws InterruptedException { wait(0); } // å½“ç¡®å®šæ²¡æœ‰å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨çš„æ—¶å€™, ç”±åƒåœ¾æ”¶é›†å™¨åœ¨å¯¹è±¡ä¸Šè¿›è¡Œè°ƒç”¨ protected void finalize() throws Throwable { } }">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-256a168b.css" as="style"><link rel="stylesheet" href="/assets/style-256a168b.css">
    <link rel="modulepreload" href="/assets/app-1db72e39.js"><link rel="modulepreload" href="/assets/framework-c6791857.js"><link rel="modulepreload" href="/assets/java.lang.html-f2c744ce.js"><link rel="modulepreload" href="/assets/java.lang.html-346bb089.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.png" alt="Riicarus"><!----><span class="site-name hide-in-pad">Riicarus</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="Riicarus&#39; Blog"><span class="font-icon icon iconfont icon-home" style=""></span>Riicarus&#39; Blog<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>JDK</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-current="page" href="/posts/Java/JDK/java.lang.html" class="router-link-active router-link-exact-active nav-link active" aria-label="Java lang åŒ…"><span class="font-icon icon iconfont icon-file" style=""></span>Java lang åŒ…<!----></a></li><li class="dropdown-subitem"><a href="/posts/Java/JDK/java.util.html" class="nav-link" aria-label="Java util åŒ…"><span class="font-icon icon iconfont icon-file" style=""></span>Java util åŒ…<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>JUC</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Java/JUC/ThreadPool.html" class="nav-link" aria-label="çº¿ç¨‹æ± "><span class="font-icon icon iconfont icon-file" style=""></span>çº¿ç¨‹æ± <!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>JVM</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Java/JVM/JavaMemoryArea.html" class="nav-link" aria-label="Java å†…å­˜åŒºåŸŸ"><span class="font-icon icon iconfont icon-file" style=""></span>Java å†…å­˜åŒºåŸŸ<!----></a></li><li class="dropdown-subitem"><a href="/posts/Java/JVM/JavaGC.html" class="nav-link" aria-label="Java GC"><span class="font-icon icon iconfont icon-file" style=""></span>Java GC<!----></a></li><li class="dropdown-subitem"><a href="/posts/Java/JVM/ClassLoad.html" class="nav-link" aria-label="ç±»åŠ è½½æœºåˆ¶"><span class="font-icon icon iconfont icon-file" style=""></span>ç±»åŠ è½½æœºåˆ¶<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ä»£ç è§„èŒƒ</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Java/CodeSpecification/EffectiveJava.html" class="nav-link" aria-label="EffectiveJava"><span class="font-icon icon iconfont icon-file" style=""></span>EffectiveJava<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ç®—æ³•"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>ç®—æ³•</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æ¨¡æ¿</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Algorithm/Template/DataStructure/" class="nav-link" aria-label="æ•°æ®ç»“æ„"><span class="font-icon icon iconfont icon-folder" style=""></span>æ•°æ®ç»“æ„<!----></a></li><li class="dropdown-subitem"><a href="/posts/Algorithm/Template/Search/" class="nav-link" aria-label="æœç´¢"><span class="font-icon icon iconfont icon-folder" style=""></span>æœç´¢<!----></a></li><li class="dropdown-subitem"><a href="/posts/Algorithm/Template/DynamicProgramming/" class="nav-link" aria-label="åŠ¨æ€è§„åˆ’"><span class="font-icon icon iconfont icon-folder" style=""></span>åŠ¨æ€è§„åˆ’<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ç½®æ¢ç®—æ³•</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Algorithm/Replacement/LRU.html" class="nav-link" aria-label="LRU"><span class="font-icon icon iconfont icon-file" style=""></span>LRU<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>è¯»è°±ä¸èƒ½</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Algorithm/SuchDifficult/PackFruit.html" class="nav-link" aria-label="æ°´æœæ‰“åŒ…"><span class="font-icon icon iconfont icon-file" style=""></span>æ°´æœæ‰“åŒ…<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ¶æ„è®¾è®¡"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>æ¶æ„è®¾è®¡</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>é«˜å¹¶å‘è®¾è®¡</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Architecture/HighConcurrency/SpikeSystemDesign.html" class="nav-link" aria-label="ç§’æ€ç³»ç»Ÿè®¾è®¡"><span class="font-icon icon iconfont icon-file" style=""></span>ç§’æ€ç³»ç»Ÿè®¾è®¡<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>åˆ†å¸ƒå¼</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Architecture/DistributedSystem/DistributedSystem(MIT%206.824).html" class="nav-link" aria-label="åˆ†å¸ƒå¼ç³»ç»Ÿ"><span class="font-icon icon iconfont icon-file" style=""></span>åˆ†å¸ƒå¼ç³»ç»Ÿ<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ä¸­é—´ä»¶"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>ä¸­é—´ä»¶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ç¼“å­˜</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Middleware/Cache/Cache.html" class="nav-link" aria-label="ç¼“å­˜"><span class="font-icon icon iconfont icon-file" style=""></span>ç¼“å­˜<!----></a></li><li class="dropdown-subitem"><a href="/posts/Middleware/Cache/BloomFilter.html" class="nav-link" aria-label="å¸ƒéš†è¿‡æ»¤å™¨"><span class="font-icon icon iconfont icon-file" style=""></span>å¸ƒéš†è¿‡æ»¤å™¨<!----></a></li><li class="dropdown-subitem"><a href="/posts/Middleware/Cache/Lua.html" class="nav-link" aria-label="LUA"><span class="font-icon icon iconfont icon-file" style=""></span>LUA<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æ¶ˆæ¯é˜Ÿåˆ—</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Middleware/MQ/MQ.html" class="nav-link" aria-label="æ¶ˆæ¯é˜Ÿåˆ—"><span class="font-icon icon iconfont icon-file" style=""></span>æ¶ˆæ¯é˜Ÿåˆ—<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ç»„ä»¶"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>ç»„ä»¶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/posts/Component/TimeWheel.html" class="nav-link" aria-label="æ—¶é—´è½®"><span class="font-icon icon iconfont icon-file" style=""></span>æ—¶é—´è½®<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è®¡ç®—æœºç§‘å­¦"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>è®¡ç®—æœºç§‘å­¦</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ç¼–è¯‘åŸç†</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/ComputerScience/CompilationPrinciple/CompilationPrinciple.html" class="nav-link" aria-label="ç¼–è¯‘åŸç†åŸºç¡€"><span class="font-icon icon iconfont icon-file" style=""></span>ç¼–è¯‘åŸç†åŸºç¡€<!----></a></li><li class="dropdown-subitem"><a href="/posts/ComputerScience/CompilationPrinciple/CompilationPrincipleExp.html" class="nav-link" aria-label="ç¼–è¯‘åŸç†å®éªŒ"><span class="font-icon icon iconfont icon-file" style=""></span>ç¼–è¯‘åŸç†å®éªŒ<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>è®¡ç®—æœºä½“ç³»ç»“æ„</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/ComputerScience/ComputerArchitecture/ComputerArchitecture.html" class="nav-link" aria-label="è®¡ç®—æœºä½“ç³»ç»“æ„"><span class="font-icon icon iconfont icon-file" style=""></span>è®¡ç®—æœºä½“ç³»ç»“æ„<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>è®¡ç®—æœºç½‘ç»œ</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/ComputerScience/ComputerNetworking/Generic.html" class="nav-link" aria-label="æ¦‚è¿°"><span class="font-icon icon iconfont icon-file" style=""></span>æ¦‚è¿°<!----></a></li><li class="dropdown-subitem"><a href="/posts/ComputerScience/ComputerNetworking/HTTP(S).html" class="nav-link" aria-label="HTTP(S)"><span class="font-icon icon iconfont icon-file" style=""></span>HTTP(S)<!----></a></li><li class="dropdown-subitem"><a href="/posts/ComputerScience/ComputerNetworking/WebSocket.html" class="nav-link" aria-label="WebSocket"><span class="font-icon icon iconfont icon-file" style=""></span>WebSocket<!----></a></li><li class="dropdown-subitem"><a href="/posts/ComputerScience/ComputerNetworking/TCP.html" class="nav-link" aria-label="TCP"><span class="font-icon icon iconfont icon-file" style=""></span>TCP<!----></a></li><li class="dropdown-subitem"><a href="/posts/ComputerScience/ComputerNetworking/UDP.html" class="nav-link" aria-label="UDP"><span class="font-icon icon iconfont icon-file" style=""></span>UDP<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æ•°æ®åº“</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/ComputerScience/Database/MySQL_Index.html" class="nav-link" aria-label="ç´¢å¼•"><span class="font-icon icon iconfont icon-file" style=""></span>ç´¢å¼•<!----></a></li><li class="dropdown-subitem"><a href="/posts/ComputerScience/Database/Transaction.html" class="nav-link" aria-label="äº‹åŠ¡"><span class="font-icon icon iconfont icon-file" style=""></span>äº‹åŠ¡<!----></a></li><li class="dropdown-subitem"><a href="/posts/ComputerScience/Database/SQL.html" class="nav-link" aria-label="SQL"><span class="font-icon icon iconfont icon-file" style=""></span>SQL<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ˜Ÿè¾°"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>æ˜Ÿè¾°</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/posts/StarStudio/LearningPath.html" class="nav-link" aria-label="å­¦ä¹ è·¯çº¿"><span class="font-icon icon iconfont icon-file" style=""></span>å­¦ä¹ è·¯çº¿<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/posts/InterviewLog/" class="nav-link" aria-label="é¢ç»"><span class="font-icon icon iconfont icon-folder" style=""></span>é¢ç»<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="é¡¹ç›®"><span class="title"><span class="font-icon icon iconfont icon-folder" style=""></span>é¡¹ç›®</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ç¼–è¯‘å™¨</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/Project/Compiler/LangDefine.html" class="nav-link" aria-label="è¯­è¨€å®šä¹‰"><span class="font-icon icon iconfont icon-file" style=""></span>è¯­è¨€å®šä¹‰<!----></a></li></ul></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/Riicarus" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/" class="nav-link sidebar-link sidebar-page" aria-label="Riicarus&#39; Blog"><span class="font-icon icon iconfont icon-home" style=""></span>Riicarus&#39; Blog<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">æ–‡ç« </span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">Java</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">JDK</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/posts/Java/JDK/java.lang.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Java.lang åŒ…"><!---->Java.lang åŒ…<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_1-object" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1 Object"><!---->1 Object<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_2-string" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2 String"><!---->2 String<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_2-1-åŸºç¡€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 åŸºç¡€"><!---->2.1 åŸºç¡€<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_2-2-æ·±å…¥-string" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 æ·±å…¥ String"><!---->2.2 æ·±å…¥ String<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_3-abstractstringbuilder" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3 AbstractStringBuilder"><!---->3 AbstractStringBuilder<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_4-stringbuilder" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4 StringBuilder"><!---->4 StringBuilder<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_5-stringbuffer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5 StringBuffer"><!---->5 StringBuffer<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_6-threadlocal" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6 ThreadLocal"><!---->6 ThreadLocal<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/posts/Java/JDK/java.util.html" class="nav-link sidebar-link sidebar-page" aria-label="Java.util åŒ…"><!---->Java.util åŒ…<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">JUC</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">JVM</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">ä»£ç è§„èŒƒ</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">ç®—æ³•</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">æ¶æ„è®¾è®¡</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">ä¸­é—´ä»¶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">ç»„ä»¶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">è®¡ç®—æœºç§‘å­¦</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">æ˜Ÿè¾°</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">é¡¹ç›®</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-folder" style=""></span><span class="title">é¢ç»</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><!--[--><a href="/intro.html" class="nav-link sidebar-link sidebar-page" aria-label="å…³äº"><span class="font-icon icon iconfont icon-info" style=""></span>å…³äº<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Java.lang åŒ…</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/Riicarus" target="_blank" rel="noopener noreferrer">Riicarus</a></span><span property="author" content="Riicarus"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-03-29T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 26 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT26M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category4 clickable" role="navigation">Java</span><span class="page-category-item category4 clickable" role="navigation">JDK</span><meta property="articleSection" content="Java,JDK"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag4 clickable" role="navigation">Java</span><span class="page-tag-item tag4 clickable" role="navigation">JDK</span><span class="page-tag-item tag6 clickable" role="navigation">java.lang</span><meta property="keywords" content="Java,JDK,java.lang"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_1-object" class="router-link-active router-link-exact-active toc-link level2">1 Object</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_2-string" class="router-link-active router-link-exact-active toc-link level2">2 String</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_2-1-åŸºç¡€" class="router-link-active router-link-exact-active toc-link level3">2.1 åŸºç¡€</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_2-2-æ·±å…¥-string" class="router-link-active router-link-exact-active toc-link level3">2.2 æ·±å…¥ String</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_3-abstractstringbuilder" class="router-link-active router-link-exact-active toc-link level2">3 AbstractStringBuilder</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_4-stringbuilder" class="router-link-active router-link-exact-active toc-link level2">4 StringBuilder</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_5-stringbuffer" class="router-link-active router-link-exact-active toc-link level2">5 StringBuffer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/Java/JDK/java.lang.html#_6-threadlocal" class="router-link-active router-link-exact-active toc-link level2">6 ThreadLocal</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="java-lang-åŒ…" tabindex="-1"><a class="header-anchor" href="#java-lang-åŒ…" aria-hidden="true">#</a> Java.lang åŒ…</h1><h2 id="_1-object" tabindex="-1"><a class="header-anchor" href="#_1-object" aria-hidden="true">#</a> 1 Object</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Object</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å› è°ƒç”¨ç±» çš„ è¢« static synchronized ä¿®é¥°çš„ ç±»å‹æ“¦é™¤å¯¹è±¡</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿”å›å¯¹è±¡çš„å“ˆå¸Œå€¼, å¯¹ HashMap è¿›è¡Œæ”¯æŒ</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ¯”è¾ƒå¯¹è±¡æ˜¯å¦ç›¸åŒ, å…·æœ‰ è‡ªåã€å¯¹ç§°ã€ä¼ é€’ã€ä¸€è‡´æ€§</span>
    <span class="token comment">// åªæœ‰å¼•ç”¨çš„å†…å­˜åœ°å€ç›¸åŒæ‰åˆ¤å®šç›¸åŒ</span>
    <span class="token comment">// å¦‚æœè¦é‡å†™æ­¤æ–¹æ³•, éœ€è¦åŒæ—¶é‡å†™ hashCode æ–¹æ³•, ç›®çš„æ˜¯ç»´æŒ hashCode  æ–¹æ³•çš„ä¸€èˆ¬çº¦å®š(ç›¸ç­‰çš„å¯¹è±¡å¿…é¡»æœ‰ç›¸åŒçš„å“ˆå¸Œç )</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å›å½“å‰å¯¹è±¡çš„å¤åˆ¶å¯¹è±¡</span>
    <span class="token comment">// æ‹·è´è¦æ±‚ï¼šå®ç° Cloneable æ¥å£</span>
    <span class="token comment">// æ‹·è´æ–¹å¼ï¼šæµ…æ‹·è´</span>
    <span class="token keyword">protected</span> <span class="token keyword">native</span> <span class="token class-name">Object</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼, å»ºè®®æ‰€æœ‰ç±»éƒ½é‡å†™æ­¤æ–¹æ³•</span>
    <span class="token comment">// è¿”å› ç±»å®ä¾‹åç§°@å¯¹è±¡å“ˆå¸Œç çš„æ— ç¬¦å·åå…­è¿›åˆ¶è¡¨ç¤º</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å”¤é†’åœ¨è¯¥å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„(æŸä¸€ä¸ª)çº¿ç¨‹, è¿›å…¥çº¿ç¨‹å°±ç»ªçŠ¶æ€</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å”¤é†’åœ¨è¯¥å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹, è¿›å…¥çº¿ç¨‹å°±ç»ªçŠ¶æ€</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®©çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€, ç›´åˆ°è¢« notify()/notifyAll() å”¤é†’, æˆ–è€…è¶…è¿‡æŒ‡å®šç­‰å¾…æ—¶é—´</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token comment">// åŒä¸Š</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token keyword">int</span> nanos<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;timeout value is negative&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> nanos <span class="token operator">&gt;</span> <span class="token number">999999</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                                <span class="token string">&quot;nanosecond timeout value out of range&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeout<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä½¿çº¿ç¨‹è¿›å…¥é•¿æœŸç­‰å¾…çŠ¶æ€, ç›´åˆ°ä¸”åªèƒ½è¢« notify()/notifyAll() å”¤é†’</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
     <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

    <span class="token comment">// å½“ç¡®å®šæ²¡æœ‰å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨çš„æ—¶å€™, ç”±åƒåœ¾æ”¶é›†å™¨åœ¨å¯¹è±¡ä¸Šè¿›è¡Œè°ƒç”¨</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-string" tabindex="-1"><a class="header-anchor" href="#_2-string" aria-hidden="true">#</a> 2 String</h2><h3 id="_2-1-åŸºç¡€" tabindex="-1"><a class="header-anchor" href="#_2-1-åŸºç¡€" aria-hidden="true">#</a> 2.1 åŸºç¡€</h3><p><code>String</code> æ˜¯ç”± <code>final</code> ä¿®é¥°çš„ç±», å®ç°äº† <code>Serializable</code>, <code>Comparable</code>, <code>CharSequence</code> æ¥å£.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">String</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span class="token punctuation">,</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">CharSequence</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äº <code>String</code> ç±»è¢« <code>final</code> ä¿®é¥°, å…¶å…·æœ‰å¦‚ä¸‹ç‰¹å¾:</p><ul><li><strong>ä¸å¯è¢«ç»§æ‰¿</strong>, ç±»æˆå‘˜æ–¹æ³•éƒ½é»˜è®¤ä¸º <code>final</code> æ–¹æ³•</li><li><code>String</code> ç±»ä¸€æ—¦è¢«åˆ›å»º, å°±æ— æ³•è¢«æ”¹å˜, å¯¹ <code>String</code> ç±»çš„æ“ä½œéƒ½ä¸ä¼šå½±å“åˆ°åŸå¯¹è±¡.</li></ul><p>ä¹Ÿå°±æ˜¯è¯´, <strong>ä¸€åˆ‡å¯¹ <code>String</code> ç±»çš„æ›´æ”¹æ“ä½œéƒ½ä¼šäº§ç”Ÿæ–°çš„ <code>String</code> å¯¹è±¡</strong>.</p><p><code>String</code> ç±»ä¸­ç»´æŠ¤äº†å¦‚ä¸‹æˆå‘˜å˜é‡:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">6849794470754667710L</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectStreamField</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialPersistentFields <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">ObjectStreamField</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>String</code> ç±»ç”±äºè¢« <code>final</code> ä¿®é¥°, æ— æ³•è¢«æ›´æ”¹, æ‰€ä»¥ <code>value</code> ä½¿ç”¨ <code>char[]</code> ä¿å­˜.</li><li><code>hash</code> å€¼å°†ç”¨äºç±»ä¸­çš„ <code>hashCode()</code> æ–¹æ³•çš„è®¡ç®—, æš‚ä¸”ä¸è¡¨.</li><li><code>serialVersionUID</code> ç”¨ä½œåºåˆ—åŒ–ID.</li><li><code>serialPersistentFields</code> ç”¨äºè¡¨æ˜åºåˆ—åŒ–æ—¶å“ªäº›å­—æ®µéœ€è¦è¢«é»˜è®¤åºåˆ—åŒ–.</li></ul><p><code>String</code> ç±»çš„åˆ›å»ºå¯ä»¥æœ‰ä»¥ä¸‹æ–¹æ³•:</p><ol><li>å­—é¢é‡èµ‹å€¼: <code>String str = &quot;String&quot;;</code></li><li>è¿æ¥ç¬¦èµ‹å€¼: <code>String str = &quot;Str&quot; + &quot;ing&quot;;</code></li><li>ä½¿ç”¨ <code>new</code> åˆ›å»ºå¯¹è±¡: <code>String str = new String(&quot;String&quot;);</code></li><li>è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•: <ol><li>ä½¿ç”¨<code>clone()</code>æ–¹æ³•</li><li>ä½¿ç”¨åå°„</li><li>ä½¿ç”¨ååºåˆ—åŒ–</li></ol></li></ol><p><code>String</code> è¢«è®¾ç½®ä¸ºä¸å¯å˜çš„åŸå› ä¸»è¦æ˜¯ä¸ºäº†ä¿è¯&quot;<strong>æ•ˆç‡</strong>&quot;å’Œ&quot;<strong>å®‰å…¨æ€§</strong>&quot;.</p><ul><li>å¦‚æœ <code>String</code> èƒ½è¢«ç»§æ‰¿, ç”±äºå®ƒçš„é«˜åº¦ä½¿ç”¨ç‡, ä¼šå¯¼è‡´ç¨‹åºæ€§èƒ½é™ä½.</li><li>ç”±äºæœ‰<strong>å­—ç¬¦ä¸²å¸¸é‡æ± </strong>çš„å­˜åœ¨, ä¸å¯å˜çš„ <code>String</code> ä¸ºç®¡ç†å’Œä¼˜åŒ–å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡æä¾›äº†æ›´æœ‰æ•ˆçš„é€”å¾„.</li><li>åœ¨<strong>å®‰å…¨æ€§</strong>æ–¹é¢, ç”±äºä½¿ç”¨å­—ç¬¦ä¸²çš„åœºæ™¯éå¸¸å¤š, å°†å…¶è®¾ç½®ä¸ºä¸å¯å˜å¯ä»¥æœ‰æ•ˆé˜²æ­¢å­—ç¬¦ä¸²è¢«ç¯¡æ”¹.</li><li><code>String</code> åœ¨ <code>HashMap</code>, <code>HashTable</code> ä¸­ç»å¸¸ä½œä¸º <code>key</code> è¢«ä½¿ç”¨. ç”±äºä¸å¯å˜çš„è®¾è®¡, ä½¿å¾— JVM åº•å±‚å¾ˆå®¹æ˜“åœ¨ç¼“å­˜ <code>String</code> å¯¹è±¡çš„æ—¶å€™ç¼“å­˜å…¶ <code>hashcode</code>, å¤§å¤§æé«˜äº†æ‰§è¡Œæ•ˆç‡.</li></ul><h3 id="_2-2-æ·±å…¥-string" tabindex="-1"><a class="header-anchor" href="#_2-2-æ·±å…¥-string" aria-hidden="true">#</a> 2.2 æ·±å…¥ <code>String</code></h3><h4 id="_2-2-1-string-çš„åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#_2-2-1-string-çš„åˆ›å»º" aria-hidden="true">#</a> 2.2.1 <code>String</code> çš„åˆ›å»º</h4><p>åœ¨æ·±å…¥ç†è§£ <code>String</code> ä¹‹å‰, å…ˆäº†è§£ä¸€ä¸‹ Java çš„å†…å­˜åŒºåŸŸ. Java åœ¨è¿è¡Œæ—¶, æ•°æ®åŒºåŸŸä¸»è¦åŒ…æ‹¬:</p><blockquote><p>å‚è€ƒ <a href="/posts/Java/JVM/JavaMemoryArea.html" class="">Java å†…å­˜åŒºåŸŸ</a></p></blockquote><ul><li>æ–¹æ³•åŒº (Method Area)</li><li>å †åŒº (Heap)</li><li>æœ¬åœ°æ–¹æ³•æ ˆ (Native Method Stack)</li><li>è™šæ‹Ÿæœºæ ˆ (VM Stack)</li><li>ç¨‹åºè®¡æ•°å™¨ (Program Counter Register)</li></ul><p>å¯¹äº <code>String</code> ç±»æ¥è¯´, æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ± (<code>StringPool</code>), åœ¨ HotSpot VM ä¸­ä½¿ç”¨ <code>StringTable</code> å®ç°.</p><p><code>StringTable</code> æ˜¯ä¸€ä¸ª Hash è¡¨, å…¶ä¸­å­˜å‚¨<strong>é©»ç•™å­—ç¬¦ä¸²</strong>çš„å¼•ç”¨, ä¹Ÿå°±æ˜¯å †ä¸­çš„æŸäº›å­—ç¬¦ä¸²å®ä¾‹è¢« <code>StringPool</code> å¼•ç”¨ä¹‹å, å°±ç­‰åŒè¢«èµ‹äºˆäº†é©»ç•™å­—ç¬¦ä¸²çš„èº«ä»½.</p><p><strong><code>StringPool</code>åœ¨æ¯ä¸ª HotSpot VM ä¸­çš„å®ä¾‹åªæœ‰ä¸€ä»½, è¢«æ‰€æœ‰ç±»å…±äº«.</strong></p><blockquote><p>æ³¨é‡Š: é©»ç•™å­—ç¬¦ä¸²å³è¢«åŒå¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²</p></blockquote><p><code>StringPool</code> ä¸­çš„å†…å®¹æ˜¯åœ¨ç±»åŠ è½½å®Œæˆ, ç»è¿‡éªŒè¯, å‡†å¤‡é˜¶æ®µä¹‹ååœ¨å †ä¸­ç”Ÿæˆçš„å­—ç¬¦ä¸²å¯¹è±¡å®ä¾‹çš„<strong>å¼•ç”¨å€¼</strong>è€Œ. å…·ä½“çš„å®ä¾‹å¯¹è±¡æ˜¯åœ¨å †ä¸­å¼€è¾Ÿçš„ä¸€å—ç©ºé—´å­˜æ”¾çš„.</p><p>ä¸‹é¢æˆ‘ä»¬è®¨è®º<code>String</code>çš„åˆ›å»ºè¿‡ç¨‹, ä»¥åˆ›å»º<code>&quot;String&quot;</code>ä¸¾ä¾‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> name_1 <span class="token operator">=</span> <span class="token string">&quot;String&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> name_2 <span class="token operator">=</span> <span class="token string">&quot;String&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> name_3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

name_1 <span class="token operator">==</span> name_2<span class="token punctuation">;</span> <span class="token comment">// true</span>
name_1 <span class="token operator">==</span> name_3<span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>å¦‚æœ <code>String</code> ä½¿ç”¨èµ‹å€¼åˆ›å»º, å­—é¢é‡ <code>&quot;String&quot;</code> åœ¨èµ‹å€¼å‰å°±å·²ç»è¢«æ”¾å…¥ <code>StringPool</code> ä¸­, æ‰€ä»¥ <code>name_1</code>, <code>name_2</code> å¼•ç”¨éƒ½æŒ‡å‘ <code>StringPool</code> ä¸­çš„ <code>&quot;String&quot;</code> å¯¹è±¡, <code>name_1 == name_2</code>.</p></li><li><p>å¦‚æœä½¿ç”¨ <code>new</code> è¿›è¡Œåˆ›å»º, åˆ™ä¼šå…ˆåœ¨<strong>å †</strong>ä¸­åˆ›å»ºä¸€ä¸ª <code>String</code> å¯¹è±¡, ç„¶ååˆ¤æ–­ <code>StringPool</code> ä¸­æ˜¯å¦å­˜åœ¨å­—ç¬¦ä¸²çš„å¸¸é‡, å¦‚æœä¸å­˜åœ¨åˆ™åœ¨å¸¸é‡æ± ä¸­åˆ›å»ºå¸¸é‡; å¦‚æœå­˜åœ¨åˆ™ä»€ä¹ˆéƒ½ä¸åš. æ‰€ä»¥ <code>name_3</code> æŒ‡å‘<strong>å †</strong>ä¸­çš„å¯¹è±¡.</p></li></ol><blockquote><p>æ³¨æ„: ä½¿ç”¨ <code>+</code> è¿ç®—ç¬¦æ‹¼æ¥å­—ç¬¦ä¸²æ•ˆç‡å¾ˆä½, åº•å±‚ä¼šè‡ªåŠ¨è°ƒç”¨ <code>StringBuilder</code> å¯¹è±¡è¿›è¡Œ <code>append()</code>.</p></blockquote><p><code>String</code> ç±»ä¸­ç»´æŠ¤äº†ä¸€ä¸ª <code>intern()</code> æ–¹æ³•, å…¶ä¸»è¦åŠŸèƒ½å¦‚ä¸‹:</p><ul><li>å¦‚æœ <code>StringPool</code> ä¸­åŒ…å«è°ƒç”¨è¯¥æ–¹æ³•çš„å­—ç¬¦ä¸², å°±ç›´æ¥è¿”å›å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸².</li><li>å¦‚æœä¸åŒ…å«, å°±å°†è¯¥ <code>String</code> å¯¹è±¡å­˜å…¥å¸¸é‡æ± , è¿”å›è¯¥ <code>String</code> å¯¹è±¡çš„å¼•ç”¨.</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> a1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;AA&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;BB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a1 == a1.intern() &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a1 <span class="token operator">==</span> a1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token class-name">String</span> test <span class="token operator">=</span> <span class="token string">&quot;ABABCDCD&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;ABAB&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;CDCD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> a3 <span class="token operator">=</span> <span class="token string">&quot;ABAB&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;CDCD&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a2 == a2.intern() &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a2 <span class="token operator">==</span> a2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a2 == a3 &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a2 <span class="token operator">==</span> a3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a3 == a2.intern() &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a3 <span class="token operator">==</span> a2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å†æ¥çœ‹<code>String</code>çš„åˆ›å»ºè¿‡ç¨‹,</p><ol><li>ä½¿ç”¨å­—é¢é‡åˆ›å»º <ol><li>å¸¸é‡æ± ä¸­æ²¡æœ‰å€¼: ç›´æ¥åˆ›å»ºå­—ç¬¦ä¸²å¹¶ä¿å­˜åˆ°<code>StringPool</code>ä¸­.</li><li>å¸¸é‡æ± ä¸­æœ‰å€¼: éœ€è¦åˆ¤æ–­å­—é¢é‡å€¼æ˜¯çœŸæ­£çš„<strong>å­—ç¬¦ä¸²å€¼</strong>è¿˜æ˜¯<strong>å¼•ç”¨</strong>, å¦‚æœæ˜¯å­—ç¬¦ä¸²å€¼, å°±å°†å±€éƒ¨å˜é‡æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å€¼; å¦‚æœæ˜¯å¼•ç”¨, å°±æŒ‡å‘å¼•ç”¨æŒ‡å‘çš„åœ°æ–¹.</li></ol></li><li><code>new</code>åˆ›å»º <ol><li>é¦–å…ˆåœ¨<strong>å †</strong>ä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡, ç„¶ååœ¨<code>StringPool</code>ä¸­åˆ›å»ºä¸€ä¸ª<strong>æŒ‡å‘å †ä¸­å¯¹è±¡çš„å¼•ç”¨</strong>.</li></ol></li></ol><p>å¯¹äºä»¥å­—é¢é‡å½¢å¼åˆ›å»ºçš„å­—ç¬¦ä¸², JVM ä¼šåœ¨ç¼–è¯‘æœŸæ—¶å¯¹å…¶è¿›è¡Œä¼˜åŒ–, å¹¶å°†å­—é¢é‡å€¼å­˜æ”¾åœ¨ <code>StringPool</code> ä¸­. è¿è¡ŒæœŸæ—¶åœ¨è™šæ‹Ÿæœºæ ˆæ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨é‡Œåˆ›å»ºä¸€ä¸ª <code>name</code> å±€éƒ¨å˜é‡, ç„¶åæŒ‡å‘ <code>StringPool</code> ä¸­çš„å€¼, å¦‚å›¾:</p><figure><img src="/assets/LiteralStringInStringPool-3810989f.png" alt="LiteralStringInStringPool" tabindex="0" loading="lazy"><figcaption>LiteralStringInStringPool</figcaption></figure><p>å¦‚æœæ˜¯å¼•ç”¨ç±»å‹çš„å­—é¢é‡åˆ›å»ºçš„å­—ç¬¦ä¸², è¿‡ç¨‹å¦‚ä¸‹: <img src="/assets/ReferenceStringInStringPool-90599b08.png" alt="ReferenceStringInStringPool" loading="lazy"></p><p>é’ˆå¯¹äºç¼–è¯‘å™¨ä¼˜åŒ–, å¯ä»¥æ€»ç»“ä»¥ä¸‹ä¸¤ç‚¹:</p><ol><li>å¸¸é‡å¯ä»¥è¢«è®¤ä¸ºè¿è¡Œæ—¶ä¸å¯æ”¹å˜, æ‰€ä»¥ç¼–è¯‘æ—¶è¢«ä»¥å¸¸é‡æŠ˜å æ–¹å¼ä¼˜åŒ–.</li><li>å˜é‡å’ŒåŠ¨æ€ç”Ÿæˆçš„å¸¸é‡å¿…é¡»åœ¨è¿è¡Œæ—¶ç¡®å®šå€¼, æ‰€ä»¥ä¸èƒ½åœ¨ç¼–è¯‘æœŸæŠ˜å ä¼˜åŒ–.</li></ol><h4 id="_2-2-2-string-ç±»çš„æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_2-2-2-string-ç±»çš„æ–¹æ³•" aria-hidden="true">#</a> 2.2.2 <code>String</code> ç±»çš„æ–¹æ³•</h4><p><code>equals()</code> æ–¹æ³•æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> anObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> anObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>anObject <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> anotherString <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>anObject<span class="token punctuation">;</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> anotherString<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> v1<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> anotherString<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±æºç å¯çŸ¥, <code>equals()</code> æ–¹æ³•ä¼šå…ˆæ¯”è¾ƒ<strong>å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€</strong>, å¦‚æœç›¸åŒå°±è¿”å› <code>true</code>; å¦‚æœä¸åŒå°±æ¯”è¾ƒ<strong>å­—ç¬¦ä¸²çš„å†…å®¹</strong>, ä¹Ÿå°±æ˜¯éå† <code>char[]</code> æ¯”è¾ƒæ¯ä¸€ä¸ª<strong>char</strong>æ˜¯å¦ç›¸åŒ</p><p><code>hashCode()</code> æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> hash<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            h <span class="token operator">=</span> <span class="token number">31</span> <span class="token operator">*</span> h <span class="token operator">+</span> val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        hash <span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> h<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>String</code> ç±»ä¸­çš„ <code>hash</code> å€¼é»˜è®¤ä¸º 0, å¦‚æœå­—ç¬¦ä¸²ä¸ºç©º, åˆ™ <code>hash = 0</code>; ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>hashCode()</code> æ–¹æ³•æ—¶, ä¼šæ ¹æ®å…¬å¼è®¡ç®—å‡ºå¯¹åº”çš„ hash å€¼å¹¶ä¿å­˜åœ¨ <code>hash</code> å±æ€§ä¸­. Hash çš„ç®—æ³•å¦‚ä¸‹:</p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>n</mi><mo>âˆ’</mo><mn>1</mn></mrow></msubsup><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>âˆ—</mo><mn>3</mn><msup><mn>1</mn><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>âˆ’</mo><mi>i</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mspace linebreak="newline"></mspace><mtext>Â </mtext><mspace linebreak="newline"></mspace><mtext>å³</mtext><mo>:</mo><mi>s</mi><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo><mo>âˆ—</mo><mn>3</mn><msup><mn>1</mn><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>s</mi><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo><mo>âˆ—</mo><mn>3</mn><msup><mn>1</mn><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>âˆ’</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><mi>s</mi><mo stretchy="false">[</mo><mi>n</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\sum_{i=0}^{n-1} s[i]*31^{(n-i-1)} \\\ \\ å³: s[0]*31^{(n-1)} + s[1]*31^{(n-2)} + ... + s[n-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2537em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord">3</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">âˆ’</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0em;"></span><span class="mspace">Â </span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">å³</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></p><blockquote><p>æ€»ç»“:</p><p>å…³äº <code>equals()</code> å’Œ <code>hashCode()</code> æ–¹æ³•, Javaä¸­æœ‰å¦‚ä¸‹è§„èŒƒ:</p><ol><li>å¦‚æœä¸¤ä¸ªå¯¹è±¡ <code>equals()</code>, åˆ™å®ƒä»¬çš„ hashcode ä¸€å®šç›¸ç­‰.</li><li>å¦‚æœä¸¤ä¸ªå¯¹è±¡ä¸ <code>equals()</code>, å®ƒä»¬çš„ hashcode å¯èƒ½ç›¸ç­‰.</li><li>å¦‚æœä¸¤ä¸ªå¯¹è±¡çš„ hashcode ç›¸ç­‰, åˆ™å®ƒä»¬ä¸ä¸€å®š <code>equals()</code>.</li><li>å¦‚æœä¸¤ä¸ªå¯¹è±¡çš„ hashcode ä¸ç›¸ç­‰, åˆ™å®ƒä»¬ä¸€å®šä¸ <code>equals()</code>.</li></ol></blockquote><p><code>compareTo()</code> æ˜¯ <code>String</code> å¯¹ <code>Comparable</code> æ¥å£çš„å®ç°, å…¶æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">String</span> anotherString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> len1 <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len2 <span class="token operator">=</span> anotherString<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> lim <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>len1<span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> v1<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> anotherString<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> lim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> c1 <span class="token operator">=</span> v1<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> c2 <span class="token operator">=</span> v2<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c1 <span class="token operator">!=</span> c2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c1 <span class="token operator">-</span> c2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        k<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> len1 <span class="token operator">-</span> len2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>compareTo()</code> ä¼šè¿›è¡Œä¸¤ä¸ªæ¯”è¾ƒ:</p><ul><li>æœ€å°é•¿åº¦çš„å­—ç¬¦ä¸²æŒ‰å­—ç¬¦æ¯”è¾ƒ</li><li>å¦‚æœå‰è€…æ²¡æœ‰æ¯”è¾ƒå‡ºç»“æœ, å°±æ¯”è¾ƒå­—ç¬¦ä¸²é•¿åº¦, è¿”å›å­—ç¬¦ä¸²é•¿åº¦å·®å€¼.</li></ul><p><code>startsWith()</code> æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">,</span> <span class="token keyword">int</span> toffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> ta<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token keyword">to</span> <span class="token operator">=</span> toffset<span class="token punctuation">;</span>
    <span class="token keyword">char</span> pa<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> prefix<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">int</span> po <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pc <span class="token operator">=</span> prefix<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// Note: toffset might be near -1&gt;&gt;&gt;1.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>toffset <span class="token operator">&gt;</span> value<span class="token punctuation">.</span>length <span class="token operator">-</span> pc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>pc <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ta<span class="token punctuation">[</span><span class="token keyword">to</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">!=</span> pa<span class="token punctuation">[</span>po<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœè¯¥å­—ç¬¦ä¸²ä» <code>toffset</code> å¼€å§‹çš„å­—ä¸²ä»¥ <code>prefix</code> ä¸ºå‰ç¼€, å°±è¿”å› <code>true</code>, å¦åˆ™è¿”å› <code>false</code>.</p><p><code>endsWith()</code> å®é™…è°ƒç”¨äº† <code>startsWith()</code> æ–¹æ³•:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> suffix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>suffix<span class="token punctuation">,</span> value<span class="token punctuation">.</span>length <span class="token operator">-</span> suffix<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯”è¾ƒå’Œ <code>suffix</code> ç›¸åŒä½æ•°çš„è¯¥å­—ç¬¦ä¸²çš„æœ«å°¾å­—ä¸²æ˜¯å¦ç›¸åŒ.</p><p><code>indexOf()</code> æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> <span class="token keyword">int</span> fromIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">final</span> <span class="token keyword">int</span> max <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>fromIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         fromIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fromIndex <span class="token operator">&gt;=</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Note: fromIndex might be near -1&gt;&gt;&gt;1.</span>
         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token constant">MIN_SUPPLEMENTARY_CODE_POINT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// handle most cases here (ch is a BMP code point o</span>
         <span class="token comment">// negative value (invalid code point))</span>
         <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> fromIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">return</span> i<span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">indexOfSupplementary</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> fromIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿”å›å‚æ•°å­—ç¬¦ <code>ch</code> åœ¨è¯¥å­—ç¬¦ä¸²ä» <code>fromIndex</code> å¼€å§‹çš„å­—ä¸²ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ index</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">indexOfSupplementary</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> <span class="token keyword">int</span> fromIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isValidCodePoint</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">char</span> hi <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">highSurrogate</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">char</span> lo <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">lowSurrogate</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> max <span class="token operator">=</span> value<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> fromIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> hi <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> lo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>indexOfSupplementary()</code> æ–¹æ³•å¯¹ä¸¤ä¸ªå­—èŠ‚å­—ç¬¦çš„å‚æ•° (å¦‚: emoji) è¿›è¡Œå¤„ç†, é€»è¾‘å¤§è‡´ç›¸åŒ.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isValidCodePoint</span><span class="token punctuation">(</span><span class="token keyword">int</span> codePoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Optimized form of:</span>
    <span class="token comment">//     codePoint &gt;= MIN_CODE_POINT &amp;&amp; codePoint &lt;= MAX_CODE_POINT</span>
    <span class="token keyword">int</span> plane <span class="token operator">=</span> codePoint <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> plane <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">MAX_CODE_POINT</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>isValidCodePoint()</code> æ–¹æ³•ç”¨äºåˆ¤æ–­ä»£ç ç‚¹æ˜¯å¦ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„ Unicode ä»£ç èŠ‚ç‚¹.</p><p><code>&gt;&gt;&gt;</code> è¡¨ç¤ºæ— ç¬¦å·å³ç§».</p><p><code>split()</code> æ–¹æ³•è¾ƒä¸ºå¤æ‚, æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token class-name">String</span> regex<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>regex<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
         <span class="token string">&quot;.$|()[{^?*+\\&quot;</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ch <span class="token operator">=</span> regex<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span>
         <span class="token punctuation">(</span>regex<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span>
          regex<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">&#39;\\&#39;</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">=</span> regex<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token char">&#39;9&#39;</span><span class="token operator">-</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>ch<span class="token operator">-</span><span class="token char">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token char">&#39;z&#39;</span><span class="token operator">-</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>ch<span class="token operator">-</span><span class="token char">&#39;A&#39;</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token char">&#39;Z&#39;</span><span class="token operator">-</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>ch <span class="token operator">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token constant">MIN_HIGH_SURROGATE</span> <span class="token operator">||</span>
         ch <span class="token operator">&gt;</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token constant">MAX_LOW_SURROGATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> limited <span class="token operator">=</span> limit <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>next <span class="token operator">=</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>limited <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>off<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                off <span class="token operator">=</span> next <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment">// last one</span>
                <span class="token comment">//assert (list.size() == limit - 1);</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>off<span class="token punctuation">,</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                off <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// If no match was found, return this</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// Add remaining segment</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>limited <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>off<span class="token punctuation">,</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Construct result</span>
        <span class="token keyword">int</span> resultSize <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resultSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resultSize<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>resultSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> resultSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>if åˆ¤æ–­ä¸­<strong>ç¬¬ä¸€ä¸ªæ‹¬å·</strong>å…ˆåˆ¤æ–­ä¸€ä¸ªå­—ç¬¦çš„æƒ…å†µ, å¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸æ˜¯ä»»ä½•ç‰¹æ®Šçš„æ­£åˆ™è¡¨è¾¾å¼. å¦‚æœè¦æ ¹æ®ç‰¹æ®Šå­—ç¬¦æ¥æˆªå–å­—ç¬¦ä¸², åˆ™éœ€è¦ä½¿ç”¨ <code>\\</code> æ¥è¿›è¡Œå­—ç¬¦è½¬ä¹‰.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">(</span>regex<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
             <span class="token string">&quot;.$|()[{^?*+\\&quot;</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ch <span class="token operator">=</span> regex<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>if åˆ¤æ–­ä¸­, <strong>ç¬¬äºŒä¸ªæ‹¬å·</strong>åˆ¤æ–­æœ‰ä¸¤ä¸ªå­—ç¬¦çš„æƒ…å†µ, å¹¶ä¸”å¦‚æœè¿™ä¸¤ä¸ªå­—ç¬¦æ˜¯ä»¥<code>\</code>å¼€å¤´çš„, å¹¶ä¸”ç¬¬äºŒä¸ªå­—ç¬¦ä¸æ˜¯å­—æ¯æˆ–è€…æ•°å­—çš„æ—¶å€™.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">(</span>regex<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> regex<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">&#39;\\&#39;</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">=</span> regex<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token char">&#39;9&#39;</span><span class="token operator">-</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span><span class="token punctuation">(</span>ch<span class="token operator">-</span><span class="token char">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token char">&#39;z&#39;</span><span class="token operator">-</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ch<span class="token operator">-</span><span class="token char">&#39;A&#39;</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token char">&#39;Z&#39;</span><span class="token operator">-</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ¤æ–­å®Œä¹‹å, åœ¨è¿›è¡Œ<strong>ç¬¬ä¸‰ä¸ªæ‹¬å·</strong>åˆ¤æ–­, åˆ¤æ–­æ˜¯å¦ä¸ºä¸¤å­—èŠ‚çš„ Unicode å­—ç¬¦.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">(</span>ch <span class="token operator">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token constant">MIN_HIGH_SURROGATE</span> <span class="token operator">||</span>
             ch <span class="token operator">&gt;</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token constant">MAX_LOW_SURROGATE</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ¥çœ‹ä¸»è¦å¤„ç†é€»è¾‘, é€»è¾‘åˆ‡åˆ†ä¸è§£é‡Šéƒ½åœ¨æ³¨é‡Šä¸­æ ‡å‡º:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">int</span> off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> limited <span class="token operator">=</span> limit <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å¦‚æœå‰©ä½™å­—ä¸²è¿˜èƒ½è¢«åˆ‡åˆ†çš„æƒ…å†µ</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>next <span class="token operator">=</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>limited <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>off<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        off <span class="token operator">=</span> next <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æœ€åä¸€ä¸ªåˆ‡åˆ†, ç›´æ¥æ·»åŠ å‰©ä½™å­—ä¸²</span>
        <span class="token comment">// æ‰§è¡Œåˆ°æ­¤å¤„, list.size() == limit - 1, æ‰§è¡Œå®Œæ¯•å list.size() == limit</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>off<span class="token punctuation">,</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        off <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// If no match was found, return this</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ç”¨äºæ²¡æœ‰é™åˆ¶æˆ–è€…é™åˆ¶æ•°é‡å¤§äºå®é™…èƒ½åˆ‡åˆ†çš„æ•°é‡çš„æƒ…å†µ, å°†å‰©ä½™å­—ä¸²æ·»åŠ åˆ°list</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>limited <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>off<span class="token punctuation">,</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Construct result</span>
<span class="token keyword">int</span> resultSize <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å¤„ç†æ— é™åˆ¶çš„åˆ‡åˆ†æƒ…å†µä¸‹å°¾éƒ¨æœ‰ç©ºä¸²(&quot;&quot;)çš„æƒ…å†µ, ç›´æ¥åˆ é™¤æ‰å°¾éƒ¨æ‰€æœ‰çš„ç©ºä¸²</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resultSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultSize<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>resultSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> resultSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºå…¥å‚limit, å¯ä»¥æ€»ç»“ä¸€ä¸‹ï¼š</p><ol><li><code>limit &gt; 0</code>, <code>split()</code> æ–¹æ³•æœ€å¤šæŠŠå­—ç¬¦ä¸²æ‹†åˆ†æˆ <code>limit</code> ä¸ªéƒ¨åˆ†.</li><li><code>limit == 0</code>, <code>split()</code> æ–¹æ³•ä¼šæ‹†åˆ†åŒ¹é…åˆ°çš„æœ€åä¸€ä½ <code>regex</code>, å¹¶åˆ é™¤æ‰æœ«å°¾çš„ç©ºä¸².</li><li><code>limit &lt; 0</code>, <code>split()</code> æ–¹æ³•ä¼šæ ¹æ® <code>regex</code> åŒ¹é…åˆ°çš„æœ€åä¸€ä½, å¦‚æœæœ€åä¸€ä½ä¸º <code>regex</code>, åˆ™å¤šæ·»åŠ ä¸€ä½ç©ºå­—ç¬¦ä¸²ï¼›å¦‚æœä¸æ˜¯åˆ™æ·»åŠ  <code>regex</code> åˆ°å­—ç¬¦ä¸²æœ«å°¾çš„å­å­—ç¬¦ä¸².</li></ol><p>ä¸¾ä¾‹å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;what!is!!!&quot;</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// [what, is]</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [what, is, , , ]</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [what, is, !!]</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [what, is, , , ]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-abstractstringbuilder" tabindex="-1"><a class="header-anchor" href="#_3-abstractstringbuilder" aria-hidden="true">#</a> 3 AbstractStringBuilder</h2><p><code>AbstractStringBuilder</code> æ˜¯ <code>StringBuilder</code>, <code>StringBuffer</code> çš„çˆ¶ç±», å®ç°äº† <code>Appendable</code> ä»¥åŠ<code>CharSequence</code>æ¥å£.</p><p><code>AbstractStringBuilder</code> ä¸­å¤§é‡ä½¿ç”¨äº† <code>System.arrayCopy()</code> æ–¹æ³•.</p><p><code>AbstractStringBuilder</code> ç»´æŠ¤äº†ä¸¤ä¸ªå±æ€§: <code>value</code> å’Œ <code>count</code>.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä¿å­˜å­—ç¬¦ä¸².</span>
<span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">;</span>

<span class="token comment">// ä¿å­˜å­—ç¬¦ä¸²é•¿åº¦, è¢« length()æ–¹æ³•ç›´æ¥è¿”å›.</span>
<span class="token keyword">int</span> count<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AbstractStringBuilder</code> æœ‰ä¸¤ä¸ªæ„é€ å™¨:</p><p>æœ‰å‚æ„é€ ç”¨äºåœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º <code>capacity</code> çš„ <code>char[]</code>. <code>StringBuilder</code> å’Œ <code>StringBuffer</code> çš„æ„é€ å™¨éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractStringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token class-name">AbstractStringBuilder</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æˆ‘ä»¬å…³æ³¨ <code>AbstractStringBuilder</code> çš„æ‰©å®¹åŸç†:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> minimumCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>minimumCapacity <span class="token operator">-</span> value<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>
                <span class="token function">newCapacity</span><span class="token punctuation">(</span>minimumCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ensureCapacityInternal()</code> æ–¹æ³•ç¡®ä¿æ¯æ¬¡æ‰§è¡Œæ·»åŠ æ“ä½œéƒ½æœ‰è¶³å¤Ÿçš„ç©ºé—´. åˆ¤æ–­å‡ºéœ€è¦æ‰©å®¹æ—¶, ä¼š<strong>è°ƒç”¨ <code>newCapacity()</code> æ–¹æ³•æ¥ç¡®å®šæ–°çš„å®¹é‡å¤§å°</strong>.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_ARRAY_SIZE</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">newCapacity</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>length <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">-</span> minCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newCapacity <span class="token operator">=</span> minCapacity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token constant">MAX_ARRAY_SIZE</span> <span class="token operator">-</span> newCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">hugeCapacity</span><span class="token punctuation">(</span>minCapacity<span class="token punctuation">)</span>
        <span class="token operator">:</span> newCapacity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ‰©å®¹è§„å®šä¸º: åŸå®¹é‡ * 2 + 2</strong>, å¦‚æœè¶³å¤Ÿä½¿ç”¨, å°±ä½¿ç”¨æ‰©å®¹åçš„å®¹é‡; å¦‚æœè¿˜æ˜¯ä¸å¤Ÿä½¿ç”¨, å°±ç›´æ¥ä½¿ç”¨ä¼ å…¥æ•°æ®ä½œä¸ºæ‰©å®¹åçš„å®¹é‡.</p><p>ç¡®å®šæ‰©å®¹åçš„å®¹é‡å, ä¼šè¿›è¡Œæº¢å‡ºåˆ¤æ–­, å¦‚æœå®¹é‡æº¢å‡º, ä¼šè°ƒç”¨ <code>hugeCapacity()</code> æ–¹æ³•è¿›è¡Œæº¢å‡ºå¤„ç†.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">hugeCapacity</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// overflow</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">-</span> minCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OutOfMemoryError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>minCapacity<span class="token punctuation">,</span> <span class="token constant">MAX_ARRAY_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœå®¹é‡ä¸å°äº <code>Integer.MAX_VALUE</code>, ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸; å¦åˆ™è¿”å› <code>minCapacity</code> å’Œ <code>MAX_ARRAY_SIZE</code> çš„æœ€å¤§å€¼.</p><hr><p>äº†è§£å®Œæ‰©å®¹, å†æ¥çœ‹çœ‹å®¹é‡ä¼˜åŒ–: å®¹é‡ä¼˜åŒ–ä¸»è¦ç”± <code>trimToSize()</code> æ–¹æ³•å®Œæˆ, æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">trimToSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœå®é™…ä½¿ç”¨çš„ç©ºé—´å°äºæ‰©å®¹åå ç”¨çš„ç©ºé—´, å°±ä¼šç¼©å‡ç©ºé—´åˆ°å½“å‰æœ€å°ç©ºé—´.è°ƒç”¨æ­¤æ–¹æ³•å, å¯èƒ½ä¼šå½±å“ <code>capacity()</code> æ–¹æ³•çš„è¿”å›å€¼.</p><blockquote><p>æ³¨æ„:</p><p><code>AbstractStringBuilder</code> çš„ä¸¤ä¸ªæ–¹æ³•: <code>length()</code> å’Œ <code>capacity()</code> æ–¹æ³•è¿”å›çš„å€¼å¯èƒ½ä¸åŒ.</p><p><code>length()</code> æ–¹æ³•ç›´æ¥è¿”å› <code>count</code> çš„å€¼, æ˜¯å½“å‰ä¿å­˜å­—ç¬¦çš„æ•°é‡;</p><p>è€Œ <code>capacity()</code> æ–¹æ³•è¿”å›çš„æ˜¯ <code>value.length</code>, ä¹Ÿå°±æ˜¯æ•°ç»„çš„å¤§å°;</p></blockquote><p>ç›¸æ¯”ä¹‹ä¸‹, <code>AbstractStringBuilder</code> çš„ <code>setLength()</code> æ–¹æ³•æ˜¯æ¯”è¾ƒæš´åŠ›çš„:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLength</span><span class="token punctuation">(</span><span class="token keyword">int</span> newLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newLength <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>newLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span>newLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> newLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> count<span class="token punctuation">,</span> newLength<span class="token punctuation">,</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    count <span class="token operator">=</span> newLength<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ–¹æ³•ä¼šé¦–å…ˆä¿è¯ <code>char[]</code> å®¹é‡å¤§å°è‡³å°‘ä¸º <code>newLength</code> (å³å¯èƒ½è¿›è¡Œæ‰©å®¹), ç„¶åå’Œå½“å‰å¤§å°è¿›è¡Œæ¯”è¾ƒ:</p><ul><li>å¦‚æœå¤§äºå½“å‰å¤§å°, å°±å°†æ‰©å®¹åçš„ç©ºå­—ç¬¦éƒ½ç”¨ <code>&#39;\0&#39;</code> å¡«å…….</li><li>å¦‚æœå°äºå½“å‰å¤§å°, å°±ä»¤ <code>count = newLength</code>, ä¹Ÿå°±è¡¨ç¤ºä¿å­˜çš„æ•°æ®é•¿åº¦åªæœ‰ <code>newLength</code>, <code>newLength</code> åé¢çš„æ•°æ®ä¼šè¢«æŠ›å¼ƒæ‰.</li></ul><p>ä¸¾ä¾‹å¦‚ä¸‹, æ³¨æ„æ¯æ¬¡ <code>setLength()</code> ä¼šä¸ä¼šè§¦å‘æ‰©å®¹ä»¥åŠå¡«å……/èˆå¼ƒæ•°æ®:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;size:&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;capacity&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 16</span>

sb<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// he</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;size:&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;capacity&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 16</span>

sb<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// he\0\0\0\00\0\0\00\0\0\00\0\0\0\0\0</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;size:&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 20</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;capacity&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 34</span>

sb<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">77</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;size:&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 77</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;capacity&quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 77</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ¥çœ‹çœ‹ <code>charAt()</code> æ–¹æ³•, æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">char</span> <span class="token function">charAt</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç›´æ¥è¿”å›å¯¹åº” index çš„å­—ç¬¦.</p><p><code>setCharAt()</code> æ–¹æ³•åŒç†.</p><p><code>append()</code> ç›¸å…³æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•, æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AbstractStringBuilder</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">appendNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> len <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span>count <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    str<span class="token punctuation">.</span><span class="token function">getChars</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> value<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    count <span class="token operator">+=</span> len<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹, å¦‚éœ€è¦å°±è¿›è¡Œæ‰©å®¹. ç„¶åè°ƒç”¨ <code>String#getChars()</code> æ–¹æ³•å°† <code>str</code> è¿½åŠ åˆ° <code>value</code> æ•°ç»„ä¸­, ç„¶åæ›´æ–° <code>count</code>.</p><p><code>String#getChars()</code> è¢«å¹¿æ³›ç”¨äºå°†å­—ç¬¦ä¸²æ·»åŠ åˆ°æ‰©å®¹åçš„æ•°ç»„ä¸­, æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getChars</span><span class="token punctuation">(</span><span class="token keyword">int</span> srcBegin<span class="token punctuation">,</span> <span class="token keyword">int</span> srcEnd<span class="token punctuation">,</span> <span class="token keyword">char</span> dst<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> dstBegin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>srcBegin <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>srcBegin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>srcEnd <span class="token operator">&gt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>srcEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>srcBegin <span class="token operator">&gt;</span> srcEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>srcEnd <span class="token operator">-</span> srcBegin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> srcBegin<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> dstBegin<span class="token punctuation">,</span> srcEnd <span class="token operator">-</span> srcBegin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®åˆ™ä¹Ÿæ˜¯è°ƒç”¨ <code>System.arrayCopy()</code> æ–¹æ³•è¿›è¡Œçš„.</p><blockquote><p>æ³¨æ„: éœ€è¦æ³¨æ„çš„æ˜¯, <code>appendNull()</code> æ·»åŠ çš„æ˜¯ <code>&quot;null&quot;</code> å­—ç¬¦ä¸², è€Œè¢«æ·»åŠ çš„å‚æ•°ä¸º <code>boolean</code> æ—¶, æ·»åŠ çš„æ—¶ <code>&quot;true&quot;</code>/<code>&quot;false&quot;</code>.</p></blockquote><p><code>subString()</code> æ–¹æ³•è°ƒç”¨äº† <code>new String()</code> æ¥è¿›è¡Œæ“ä½œ:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">substring</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&gt;</span> count<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;</span> end<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åçœ‹ä¸€ä¸‹ <code>reverse()</code> æ–¹æ³•, æºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AbstractStringBuilder</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> hasSurrogates <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> k <span class="token operator">=</span> n <span class="token operator">-</span> j<span class="token punctuation">;</span>
        <span class="token keyword">char</span> cj <span class="token operator">=</span> value<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> ck <span class="token operator">=</span> value<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
        value<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">;</span>
        value<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> cj<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isSurrogate</span><span class="token punctuation">(</span>cj<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isSurrogate</span><span class="token punctuation">(</span>ck<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hasSurrogates <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasSurrogates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reverseAllValidSurrogatePairs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆ <code>j</code> å’Œ <code>k</code>. å…³äºä¸­å¿ƒå¯¹ç§°. ä»ä¸­é—´å¼€å§‹ä¸€è¾¹å‘ä¸¤è¾¹éå†, ä¸€è¾¹äº¤æ¢. å°±å®Œæˆäº†ç¿»è½¬.</p><h2 id="_4-stringbuilder" tabindex="-1"><a class="header-anchor" href="#_4-stringbuilder" aria-hidden="true">#</a> 4 StringBuilder</h2><p>çœ‹å®Œ <code>AbstractStringBuilder</code>, æˆ‘ä»¬æ¥çœ‹çœ‹ä»–çš„å­ç±» <code>StringBuilder</code>, å…¶ä¸­çš„æ ¸å¿ƒåŠŸèƒ½éƒ½å·²ç»åœ¨ <code>AbstractStringBuilder</code> ä¸­å®šä¹‰äº†. åŒæ—¶ <code>StringBuilder</code> è¿˜å®ç°äº† <code>Serializable</code> æ¥å£.</p><p>å…ˆæ¥çœ‹çœ‹<strong>æ„é€ æ–¹æ³•</strong>, ä¼šè°ƒç”¨ <code>AbstractStringBuilder</code> æ„é€ æ–¹æ³•:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>seq<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">append</span><span class="token punctuation">(</span>seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ„é€ å™¨æœ‰ä¸‰ä¸ªä¸»è¦æƒ…å†µ:</p><ul><li>å¦‚æœæ˜¯æ— å‚æ„é€ , åˆ™é»˜è®¤è®¾ç½®å®¹é‡ä¸º<strong>16</strong>;</li><li>å¦‚æœä¼ å…¥å®¹é‡, å°±å°†å®¹é‡è®¾ç½®ä¸º<strong>ä¼ å…¥å®¹é‡çš„å¤§å°</strong>;</li><li>å¦‚æœä¼ å…¥ <code>String</code> æˆ– <code>CharSequence</code>, å°±è®¾ç½®ä¸º<strong>ä¼ å…¥ä¸²çš„é•¿åº¦ + 16</strong>, å¹¶ä¸”æ·»åŠ ä¼ å…¥çš„ä¸².</li></ul><p>å†æ¥çœ‹ä¸€äº›å¸¸ç”¨çš„æ–¹æ³•:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">StringBuilder</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> str<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> str<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">StringBuilder</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a copy, don&#39;t share the array</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°, å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯ç›´æ¥è°ƒç”¨äº†çˆ¶ç±» <code>AbstractStringBuilder</code> çš„æ–¹æ³•, ç„¶åè¿”å› <code>this</code>.</p><p>ä½†æ˜¯ç”±äºçˆ¶ç±»çš„ <code>toString()</code> æ–¹æ³•æ˜¯æŠ½è±¡æ–¹æ³•, æ‰€æœ‰è¿™é‡Œé‡å†™äº† <code>toString()</code> æ–¹æ³•.</p><h2 id="_5-stringbuffer" tabindex="-1"><a class="header-anchor" href="#_5-stringbuffer" aria-hidden="true">#</a> 5 StringBuffer</h2><p>çœ‹å®Œçº¿ç¨‹ä¸å®‰å…¨çš„ <code>StringBuilder</code>, å†æ¥çœ‹çœ‹çº¿ç¨‹å®‰å…¨çš„ <code>StringBuffer</code>, åŒæ ·ä¹Ÿæ˜¯ç»§æ‰¿äº†çˆ¶ç±» <code>AbstractStringBuilder</code>, å¹¶ä¸”å®ç°äº† <code>Serializable</code>ä»¥åŠ <code>CharSequence</code> æ¥å£.</p><blockquote><p>é—®é¢˜:</p><p>ä¸ºä»€ä¹ˆ <code>AbstractStringBuilder</code> å·²ç»å®ç°äº† <code>CharSequence</code> æ¥å£, <code>StringBuffer</code> è¿˜è¦å†å®ç°ä¸€æ¬¡ <code>CharSequence</code> æ¥å£?</p></blockquote><p><code>StringBuffer</code> çš„å¤§å¤šæ•°æ–¹æ³•éƒ½æ˜¯åœ¨ <code>StringBuilder</code> çš„æ–¹æ³•åŸºç¡€ä¸ŠåŠ ä¸Š <code>synchronized</code> å…³é”®å­—, ç”¨äºä¿è¯çº¿ç¨‹å®‰å…¨.</p><p><code>StringBuffer</code> è¿˜æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯, å®ƒåŠ å…¥äº†ç¼“å­˜æœºåˆ¶--<code>toStringCache</code> å±æ€§.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> toStringCache<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toStringCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toStringCache <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>toStringCache<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">StringBuffer</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    toStringCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">StringBuffer</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    toStringCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ° <code>toStringCache</code> ä¼šç¼“å­˜æœ€åä¸€æ¬¡ <code>toString()</code> çš„ç»“æœ, å¹¶ä¸”æ¯ä¸€æ¬¡å¯¹ <code>value</code> çš„ä¿®æ”¹, éƒ½ä¼šé‡ç½® <code>toStringCache</code> ä¸º <code>null</code>;</p><p>å¦‚æœ <code>toStringCache</code> æœ‰æ•ˆ(éç©º), åˆ™å½“è°ƒç”¨ <code>toString()</code> æ–¹æ³•æ—¶ç›´æ¥è¿”å› <code>toStringCache</code> çš„å€¼,è€Œä¸éœ€è¦ä½¿ç”¨æ¶ˆè€—æ€§èƒ½çš„ <code>Arrays.copyOfRange()</code> æ–¹æ³•.</p><h2 id="_6-threadlocal" tabindex="-1"><a class="header-anchor" href="#_6-threadlocal" aria-hidden="true">#</a> 6 ThreadLocal</h2><p><code>ThreadLocal</code> æ˜¯ä¸€ä¸ªæ˜¯ç”± JDK æä¾›çš„ä¸€ä¸ªç”¨äº<strong>å­˜å‚¨æ¯ä¸ªçº¿ç¨‹æœ¬åœ°å‰¯æœ¬ä¿¡æ¯çš„ç±»</strong>. æˆ‘ä»¬å…ˆçœ‹çœ‹å®˜æ–¹æ³¨é‡Š:</p><blockquote><p>å®˜æ–¹æ³¨é‡Š:</p><p>è¿™ä¸ªç±»ç”¨äºæä¾›çº¿ç¨‹æœ¬åœ°å˜é‡, è¿™äº›å˜é‡å’Œæ™®é€šçš„å˜é‡ä¸åŒ, <strong>å› ä¸ºæ¯ä¸ªçº¿ç¨‹é€šè¿‡è®¿é—® <code>ThreadLocal</code> çš„<code>get()</code>æˆ–è€…æ˜¯ <code>set()</code> æ–¹æ³•éƒ½ä¼šè·å¾—å…¶ç‹¬ç«‹çš„ã€åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬</strong>. <em><code>ThreadLocal</code>å®ä¾‹é€šå¸¸æ˜¯å¸Œæœ›å°†çº¿ç¨‹ç‹¬æœ‰çš„çŠ¶æ€(ä¾‹å¦‚ç”¨æˆ·ID/äº¤æ˜“ID) çº¿ç¨‹ä¸­çš„ç§æœ‰é™æ€å­—æ®µè¿›è¡Œå…³è”, å³å°†çº¿ç¨‹ç‹¬æœ‰çš„çŠ¶æ€å­˜å‚¨åˆ°çº¿ç¨‹ä¸­.</em></p><p>æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæŒæœ‰ä¸€ä¸ªæŒ‡å‘ <code>ThreadLocal</code> å˜é‡çš„éšå¼å¼•ç”¨, åªè¦çº¿ç¨‹è¿˜æ²¡æœ‰ç»“æŸ, è¯¥å¼•ç”¨å°±ä¸ä¼šè¢« GC. ä½†å½“çº¿ç¨‹ç»“æŸåå¹¶ä¸”å…¶ä»–åœ°æ–¹æ²¡æœ‰å¯¹è¿™äº›å‰¯æœ¬è¿›è¡Œå¼•ç”¨, åˆ™çº¿ç¨‹æœ¬åœ°å®ä¾‹çš„æ‰€æœ‰å‰¯æœ¬éƒ½ä¼šè¢« GC.</p></blockquote><p>çœ‹å®Œå®˜æ–¹æ–‡æ¡£, æˆ‘ä»¬å¯ä»¥äº†è§£åˆ° <code>ThreadLocal</code> çš„é€‚ç”¨åœºæ™¯, å¤§è‡´å¯åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»:</p><ol><li>ç”¨äºå­˜å‚¨çº¿ç¨‹æœ¬åœ°çš„å‰¯æœ¬å˜é‡, å³ä¸ºäº†åšåˆ°çº¿ç¨‹éš”ç¦».</li><li>ç”¨äºç¡®ä¿çº¿ç¨‹å®‰å…¨.</li></ol><p>ä¸è¿‡ <code>ThreadLocal</code> çš„é€‚ç”¨åœºæ™¯è¿˜ä¸æ­¢è¿™äº›:</p><ol><li><p><strong>çº¿ç¨‹èµ„æºæŒæœ‰(çº¿ç¨‹éš”ç¦»)</strong></p><figure><img src="/assets/ThreadIsolationUsingThreadLocal-d704e37c.png" alt="ThreadIsolationUsingThreadLocal.png" tabindex="0" loading="lazy"><figcaption>ThreadIsolationUsingThreadLocal.png</figcaption></figure><p>åœ¨ Web ç¨‹åºä¸­, æ¯ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ª <code>session</code>, ä¸åŒç”¨æˆ·è®¿é—®ç¨‹åºä¼šé€šè¿‡ä¸åŒçš„çº¿ç¨‹æ¥è®¿é—®, é€šè¿‡ <code>ThreadLocal</code> æ¥ä¿è¯åŒä¸€ä¸ªçº¿ç¨‹çš„è®¿é—®è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯æ˜¯ç›¸åŒçš„, åŒæ—¶ä¸ä¼šå½±å“åˆ°å…¶ä»–ç”¨æˆ·çš„ä¿¡æ¯. æ‰€ä»¥ <code>ThreadLocal</code> å¯ä»¥å¾ˆå¥½çš„ä¿è¯çº¿ç¨‹ä¹‹é—´çš„éš”ç¦»æ€§.</p></li><li><p><strong>çº¿ç¨‹èµ„æºä¸€è‡´æ€§</strong>: è¿™ä¸ªåœºæ™¯åœ¨ <code>JDBC</code> ä¸­æœ‰ä½¿ç”¨åˆ°, åœ¨ <code>JDBC</code> å†…éƒ¨ä¼šé€šè¿‡ <code>ThreadLocal</code> æ¥ä¿è¯çº¿ç¨‹èµ„æºçš„ä¸€è‡´æ€§.</p><p>æˆ‘ä»¬éƒ½çŸ¥é“, æ¯ä¸ª HTTP è¯·æ±‚éƒ½ä¼šåœ¨ web ç¨‹åºå†…éƒ¨ç”Ÿæˆä¸€ä¸ªçº¿ç¨‹, è€Œæ¯ä¸ªçº¿ç¨‹å»è®¿é—® DB çš„æ—¶å€™, éƒ½ä¼šä»æ•°æ®åº“è¿æ¥æ± è·å–ä¸€ä¸ª <code>Connection</code> è¿æ¥ç”¨äºè¿›è¡Œæ•°æ®åº“äº¤äº’. é‚£ä¹ˆå½“ä¸€ä¸ª HTTP è¯·æ±‚è¿›æ¥, è¯¥è¯·æ±‚åœ¨ç¨‹åºå†…éƒ¨è°ƒç”¨äº†ä¸åŒçš„æœåŠ¡, åœ¨è¿™ä¸ªè°ƒç”¨é“¾ä¸­æ¯æ¬¡è¯·æ±‚ä¸€ä¸ªæœåŠ¡éƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡æ•°æ®åº“äº¤äº’, é‚£å°±æœ‰äº†ä¸€ä¸ªå¦‚ä½•ç¡®ä¿åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­å’Œæ•°æ®åº“äº¤äº’çš„<strong>äº‹åŠ¡çŠ¶æ€ä¸€è‡´</strong>çš„é—®é¢˜. å¦‚æœåŒä¸€ä¸ªè¯·æ±‚çš„è°ƒç”¨é“¾ä¸­ <code>Connection</code> éƒ½ä¸åŒ, é‚£ä¹ˆå°±æ²¡æ³•è¿›è¡Œäº‹åŠ¡æ§åˆ¶äº†. å› æ­¤ <code>JDBC</code> é€šè¿‡ <code>ThreadLocal</code> æ¥ç¡®ä¿æ¯æ¬¡çš„è¯·æ±‚éƒ½å’ŒåŒä¸€ä¸ª <code>Connection</code> å¯¹åº”, ç¡®ä¿ä¸€æ¬¡è¯·æ±‚é“¾ä¸­éƒ½è°ƒç”¨çš„åŒä¸€ä¸ª <code>Connection</code>, è¿™å°±æ˜¯<strong>çº¿ç¨‹èµ„æºä¸€è‡´æ€§</strong>.</p></li><li><p><strong>çº¿ç¨‹å®‰å…¨</strong>: åŸºäº <code>ThreadLocal</code> å­˜å‚¨åœ¨ <code>Thread</code> ä¸­ä½œä¸ºæœ¬åœ°å‰¯æœ¬å˜é‡çš„æœºåˆ¶, ä¿è¯æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æœ‰ç”¨è‡ªå·±çš„ä¸Šä¸‹æ–‡, ç¡®ä¿äº†çº¿ç¨‹å®‰å…¨. ç›¸è¾ƒäºåŠ é”(<code>Synchronized</code>, <code>Lock</code>), <code>ThreadLocal</code> çš„æ•ˆç‡æ›´é«˜.</p></li><li><p><strong>åˆ†å¸ƒå¼è®¡ç®—</strong></p><figure><img src="/assets/DistributedComputingUsingThreadLocal-856a1b4e.png" alt="DistributedComputingUsingThreadLocal" tabindex="0" loading="lazy"><figcaption>DistributedComputingUsingThreadLocal</figcaption></figure><p>åœ¨åˆ†å¸ƒå¼è®¡ç®—ä¸­, æ¯ä¸ªçº¿ç¨‹éƒ½è®¡ç®—å‡ºç»“æœå, æœ€ç»ˆé€šè¿‡å°† <code>ThreadLocal</code> å­˜å‚¨çš„ç»“æœå–å‡º, æ¥è·å¾—æ‰€æœ‰çº¿ç¨‹çš„è®¡ç®—ç»“æœ.</p></li><li><p><strong>åœ¨<code>SqlSessionManager</code>ä¸­çš„ä½¿ç”¨</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlSession</span><span class="token punctuation">&gt;</span></span> localSqlSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>localSqlSession<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> sqlSession<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>SqlSessionManager</code> å¯¹ <code>SqlSession</code> çš„å­˜å‚¨æ˜¯é€šè¿‡ <code>ThreadLocal</code> å®ç°çš„.</p><p>åœ¨ <code>getConnection()</code> æ—¶å®é™…å°±æ˜¯å» <code>ThreadLocal</code> ä¸­è·å– <code>SqlSession</code> è¿æ¥.</p></li><li><p><strong>åœ¨ Spring çš„ <code>TransactionContextHolder</code> ä¸­çš„ä½¿ç”¨</strong></p><p>å…¶å®å°±æ˜¯åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­éœ€è¦ä¸€ä¸ª<code>context</code>èµ„æºä¸Šä¸‹æ–‡æ¥å­˜å‚¨ä¸€æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦å…±äº«çš„æ•°æ®, ä¾¿äºåˆ†å¸ƒå¼äº‹åŠ¡å…±åŒå¤„ç†(å¦‚: ä¸šåŠ¡å›æ»šç­‰).</p></li></ol><p>äº†è§£å®Œ <code>ThreadLocal</code> çš„ä½¿ç”¨åœºæ™¯, æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç :</p><p>åœ¨çœ‹æºç ä¹‹å‰æå‡ºå‡ ä¸ªé—®é¢˜:</p><ol><li><code>ThreadLocal</code> æ˜¯æ€ä¹ˆä¿è¯äº†çº¿ç¨‹éš”ç¦»çš„?</li><li><code>ThreadLocal</code> æ³¨é‡Šä¸­æåˆ°çš„éšå¼å¼•ç”¨æ˜¯ä»€ä¹ˆ? æœ‰ä»€ä¹ˆä½œç”¨?</li><li><code>ThreadLocal</code> ä¸ºä»€ä¹ˆè¦ç”¨åˆ°éšå¼å¼•ç”¨? è€Œä¸ç”¨å¼ºå¼•ç”¨?</li><li>æ®è¯´<code>ThreadLocal</code> ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼? ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼? å¦‚ä½•é¿å…å†…å­˜æ³„æ¼?</li><li>ä½¿ç”¨<code>ThreadLocal</code> æœ‰ä»€ä¹ˆéœ€è¦æ³¨æ„çš„ç‚¹?</li></ol><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å…¶ä¸­ä½¿ç”¨çš„æ•°æ®ç»“æ„:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç”¨äº ThreadLocal å†…éƒ¨ ThreadLocalMap æ•°æ®ç»“æ„çš„å“ˆå¸Œå€¼, ç”¨äºé™ä½å“ˆå¸Œå†²çª.</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadLocalHashCode <span class="token operator">=</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åŸå­æ“ä½œç”Ÿæˆå“ˆå¸Œå€¼, åˆå§‹å€¼ä¸º0.</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> nextHashCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ç”¨äºè¿›è¡Œè®¡ç®—å‡º threadLocalHashCode çš„å“ˆå¸Œå€¼.</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x61c88647</span><span class="token punctuation">;</span>

<span class="token comment">// è¿”å›ä¸‹ä¸€ä¸ªå“ˆå¸Œå€¼, è®©å“ˆå¸Œå€¼æ•£åˆ—æ›´å‡åŒ€.</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextHashCode<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token constant">HASH_INCREMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ¥çœ‹ <code>TreadLocal</code> æœ€é‡è¦çš„ä¸€ä¸ªæ•°æ®ç»“æ„--<code>ThreadLocalMap</code>:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ThreadLocalMapå…¶å®å°±æ˜¯ä¸€ä¸ªç”¨äºThreadLocalçš„è‡ªå®šä¹‰HashMap, å®ƒå’ŒHashMapå¾ˆåƒ.    åœ¨å…¶å†…éƒ¨æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„Entryç±»,
 * å¹¶ä¸”æœ‰ä¸€ä¸ªEntryæ•°ç»„æ¥å­˜å‚¨è¿™ä¸ªç±»çš„å®ä¾‹å¯¹è±¡. ç±»ä¼¼äºHashMap, ThreadLocalMapåŒæ ·    çš„æ‹¥æœ‰åˆå§‹å¤§å°, æ‹¥æœ‰æ‰©å®¹é˜ˆå€¼.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">{</span>

    <span class="token comment">/*
  * å¯ä»¥çœ‹åˆ°, Entryç±»ç»§æ‰¿äº†WeakReferenceç±», å®ƒçš„å«ä¹‰æ˜¯å¼±å¼•ç”¨, å³JVMè¿›è¡ŒGC   * æ—¶, æ— è®ºå½“å‰å†…å­˜æ˜¯å¦å¤Ÿç”¨, éƒ½ä¼šæŠŠè¢«WeakReferenceæŒ‡å‘çš„å¯¹è±¡å›æ”¶æ‰.
  */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

        <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> v<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ThreadLocalMap çš„åˆå§‹å¤§å°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INITIAL_CAPACITY</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

    <span class="token comment">// ç”¨äºå­˜å‚¨ Entry çš„æ•°ç»„</span>
    <span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

    <span class="token comment">// å½“å‰ Entry[] çš„å¤§å°</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// æ‰©å®¹é˜ˆå€¼, æ‰©å®¹é˜ˆå€¼ä¸ºåˆå§‹å¤§å°å€¼çš„ä¸‰åˆ†ä¹‹äºŒ.</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> threshold<span class="token punctuation">;</span> <span class="token comment">// Default to 0</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        threshold <span class="token operator">=</span> len <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">prevIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> i <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç®€ç•¥è®²è§£ä¸€ä¸‹ <code>Entry</code> ç»§æ‰¿ <code>WeakReference</code> çš„åŸå› :</p><ol><li>æ˜¯ä¸ºäº†åœ¨ <code>Thread</code> çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­, key èƒ½å¤Ÿè¢« GC æ‰, ä»è€Œåœ¨éœ€è¦å½»åº• GC æ‰ <code>ThreadLocalMap</code> æ—¶, åªéœ€è¦è°ƒç”¨ <code>ThreadLocal</code> çš„ <code>remove()</code> æ–¹æ³•å³å¯.</li><li>å¦‚æœæ˜¯ç”¨çš„å¼ºå¼•ç”¨, è™½ç„¶ <code>Entry</code> åˆ° <code>Thread</code> ä¸å¯è¾¾, ä½†æ˜¯å’Œ <code>Value</code> è¿˜æœ‰å¼ºå¼•ç”¨çš„å…³ç³», æ˜¯å¯è¾¾çš„, æ‰€ä»¥æ— æ³•è¢« GC æ‰.</li></ol><p>è™½ç„¶ <code>Entry</code> ä½¿ç”¨çš„æ˜¯ <code>WeakReference</code> è™šå¼•ç”¨, ä½† JVM åªæ˜¯å›æ”¶æ‰äº† <code>ThreadLocalMap</code> ä¸­çš„ key, ä½†æ˜¯ value å’Œ key æ˜¯å¼ºå¼•ç”¨çš„ï¼ˆvalueä¹Ÿä¼šå¼•ç”¨ <code>null</code>ï¼‰, æ‰€ä»¥ value æ˜¯æ— æ³•è¢«å›æ”¶çš„, æ‰€ä»¥å¦‚æœçº¿ç¨‹æ‰§è¡Œæ—¶é—´éå¸¸é•¿, value æŒç»­ä¸ GC, å°±æœ‰å†…å­˜æº¢å‡ºçš„é£é™©. æ‰€ä»¥æœ€å¥½çš„åšæ³•å°±æ˜¯è°ƒç”¨ <code>ThreadLocal</code> çš„ <code>remove()</code> æ–¹æ³•, æŠŠ <code>ThreadLocal.ThreadLocalMap</code> ç»™æ¸…é™¤æ‰.</p><blockquote><p>æ³¨æ„: <code>ThreadLocalMap</code> çš„ key å°±æ˜¯ <code>ThreadLocal</code> å¯¹è±¡, value å°±æ˜¯ <code>Entry</code> ä¸­ä¿å­˜çš„ <code>value</code>, é€šè¿‡ <code>Entry</code> çš„æ„é€ æ–¹æ³•æ¥å»ºç«‹èµ· <code>ThreadLocal</code> å¯¹è±¡å’Œ <code>value</code> çš„è™šå¼•ç”¨, è¿™å°±æ˜¯ä¸€å¯¹ <code>Entry</code>.</p></blockquote><p>æ¯ä¸€ä¸ª <code>Thread</code> éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ <code>ThreadLocalMap</code> å˜é‡, æˆ‘ä»¬æ¥çœ‹çœ‹ <code>Thread</code> ä¸­çš„æºç å®šä¹‰:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> inheritableThreadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥å‘ç°ç»´æŠ¤äº†ä¸¤ä¸ª <code>ThreadLocalMap</code> å¯¹è±¡, <code>threadLocals</code> æ˜¯å±äºè‡ªå·±çš„ map, <code>inheritableThreadLocals</code> æ˜¯ç”¨äºçˆ¶å­çº¿ç¨‹é—´ <code>ThreadLocal</code> å˜é‡çš„ä¼ é€’.</p><p>å›åˆ° <code>ThreadLocal</code> çš„æºç ä¸­, æˆ‘ä»¬çœ‹çœ‹ <code>set()</code> å’Œ <code>get()</code> æ–¹æ³•:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ThreadLocalä¸­çš„ set() æ–¹æ³•</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">// å°†å½“å‰çº¿ç¨‹ä¼ å…¥, ä½œä¸º ThreadLocalMap çš„å¼•ç”¨, åˆ›å»ºå‡º ThreadLocalMap</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ThreadLocalMapä¸­çš„ set() æ–¹æ³•</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// åˆå§‹åŒ–Entryæ•°ç»„</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// é€šè¿‡å–æ¨¡è®¡ç®—å‡ºç´¢å¼•å€¼</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœ ThreadLocalMap ä¸­ tab çš„æ§½ä½å·²ç»è¢«ä½¿ç”¨äº†, åˆ™å¯»æ‰¾ä¸‹ä¸€ä¸ªç´¢å¼•ä½</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœ key å¼•ç”¨è¢«å›æ”¶äº†, åˆ™ç”¨æ–°çš„ key-value æ¥æ›¿æ¢, å¹¶ä¸”åˆ é™¤æ— ç”¨çš„                Entry</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>
    <span class="token comment">// æ¸…æ¥šé‚£äº› get() ä¸ºç©ºçš„å¯¹è±¡, ç„¶åè¿›è¡Œ rehash.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
        <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹ t</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–çº¿ç¨‹ t ä¸­çš„ ThreadLocalMap</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¦‚æœæ²¡æœ‰è·å–åˆ°ThreadLocalMap, åˆ™åˆå§‹åŒ–ä¸€ä¸ªThreadLocalMap</span>
    <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆå§‹åŒ–</span>
<span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> value <span class="token operator">=</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> e<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä¾¿æ˜¯å­˜å‚¨å’Œè·å– <code>ThreadLocal</code> æ–¹æ³•, ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•æ¸…é™¤ <code>ThreadLocal</code>, é˜²æ­¢å†…å­˜æ³„æ¼, ä¹Ÿå°±æ˜¯ <code>remove()</code> æ–¹æ³•.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ThreadLocal çš„ remove() æ–¹æ³•</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹ä¸­çš„ ThreadLocalMap</span>
    <span class="token class-name">ThreadLocalMap</span> m <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        m<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ThreadLocalMap ä¸­çš„ remove() æ–¹æ³•</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// é€šè¿‡å–æ¨¡è·å–å‡ºç´¢å¼•ä½ç½®</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ¸…é™¤æ²¡ç”¨çš„æ§½ä½ä»¥åŠ null æ’æ§½, å¹¶ä¸”å¯¹å…¶è¿›è¡Œé‡æ–°æ•£åˆ—</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span><span class="token keyword">int</span> staleSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// å°†æ’æ§½ä½ç½®çš„é”®å’Œå€¼éƒ½è®¾ç½®ä¸ºnull</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    size<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token comment">// é‡åˆ°nullçš„æ’æ§½, é‡æ–°æ•£åˆ—è®¡ç®—å“ˆå¸Œå€¼</span>
    <span class="token class-name">Entry</span> e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            size<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                <span class="token keyword">while</span> <span class="token punctuation">(</span>tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹åˆ°è¿™é‡Œå¯èƒ½è¿˜æ˜¯æ¯”è¾ƒç–‘æƒ‘ <code>Thread</code>, <code>ThreadLocal</code>, <code>ThreadLocalMap</code> çš„å…³ç³», åœ¨è¿™é‡Œç»™ä¸€å¼ å›¾:</p><figure><img src="/assets/RelationOfThreadLocalMap-e677d4ad.png" alt="RelationOfThreadLocalMap" tabindex="0" loading="lazy"><figcaption>RelationOfThreadLocalMap</figcaption></figure><p><code>ThreadLocalMap</code> ä¸ºäº†å¯¹å¤–ç•Œé€æ˜, ä¸è¢«å¤–ç•Œå¹²æ‰°, æ‰€ä»¥é€šè¿‡ <code>ThreadLocal</code> çš„å°è£…è¿›è¡Œç›¸å…³æ“ä½œ.</p><p><code>Thread</code> æ‹¥æœ‰ <code>ThreadLocalMap</code> çš„å±æ€§, ä½†æ˜¯ä¸èƒ½ç›´æ¥æ“ä½œ <code>ThreadLocalMap</code>, æ‰€ä»¥éœ€è¦å€ŸåŠ© <code>ThreadLocal</code> è¿›è¡Œæ“ä½œ.</p><p>ä¸€ä¸ª <code>Thread</code> å¯ä»¥æœ‰å¤šä¸ª <code>ThreadLocal</code>, ç”¨äºç»´æŠ¤ä¸åŒçš„ <code>Value</code>.</p><figure><img src="/assets/ThreadWithThreadLocal-6729359c.png" alt="ThreadWithThreadLocal" tabindex="0" loading="lazy"><figcaption>ThreadWithThreadLocal</figcaption></figure><p>çœ‹çœ‹å¹³æ—¶çš„ç”¨æ³•:</p><figure><img src="/assets/UsageOfThreadLocal-f5e9598c.png" alt="UsageOfThreadLocal" tabindex="0" loading="lazy"><figcaption>UsageOfThreadLocal</figcaption></figure><p>è¾“å‡ºä¸º:</p><figure><img src="/assets/OutputOfUsageOfThreadLocal-6882143d.png" alt="OutputOfUsageOfThreadLocal" tabindex="0" loading="lazy"><figcaption>OutputOfUsageOfThreadLocal</figcaption></figure><p>è¯´æ˜ä¸åŒçº¿ç¨‹é€šè¿‡ <code>ThreadLocal</code> è·å– <code>ThreadLocalMap</code> ä¸­çš„æ•°æ®æ˜¯äº’ä¸å¹²æ‰°çš„.</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/Riicarus/edit/main/docs/posts/Java/JDK/java.lang.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: riicarus.acc@gmail.com">Riicarus</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><!----><a href="/posts/Java/JDK/java.util.html" class="nav-link next" aria-label="Java.util åŒ…"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">Java.util åŒ…<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-1db72e39.js" defer></script>
  </body>
</html>
